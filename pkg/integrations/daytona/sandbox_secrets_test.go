package daytona

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/superplanehq/superplane/pkg/configuration"
)

func Test__validateSandboxSecrets(t *testing.T) {
	t.Run("valid file secret", func(t *testing.T) {
		err := validateSandboxSecrets([]SandboxSecret{
			{
				Type: SandboxSecretTypeFile,
				Path: "/home/daytona/.ssh/id_rsa",
				Value: configuration.SecretKeyRef{
					Secret: "ssh-keys",
					Key:    "sandbox",
				},
			},
		})

		require.NoError(t, err)
	})

	t.Run("valid env-var secret", func(t *testing.T) {
		err := validateSandboxSecrets([]SandboxSecret{
			{
				Type: SandboxSecretTypeEnvVar,
				Name: "GITHUB_TOKEN",
				Value: configuration.SecretKeyRef{
					Secret: "credentials",
					Key:    "token",
				},
			},
		})

		require.NoError(t, err)
	})

	t.Run("missing secret ref -> error", func(t *testing.T) {
		err := validateSandboxSecrets([]SandboxSecret{
			{
				Type:  SandboxSecretTypeFile,
				Path:  "/tmp/file",
				Value: configuration.SecretKeyRef{},
			},
		})

		require.ErrorContains(t, err, "value.secret")
	})
}

func Test__buildSandboxSecretsEnvScript(t *testing.T) {
	script := buildSandboxSecretsEnvScript([]sandboxEnvBinding{
		{Name: "Z_TOKEN", Value: []byte("z-value")},
		{Name: "A_TOKEN", Value: []byte("a-value")},
	})

	assert.Contains(t, script, "# Generated by SuperPlane")
	assert.Contains(t, script, "export A_TOKEN='a-value'")
	assert.Contains(t, script, "export Z_TOKEN='z-value'")
}

func Test__wrapCommandWithSandboxSecretEnv(t *testing.T) {
	command := wrapCommandWithSandboxSecretEnv("echo hello")
	assert.Contains(t, command, "if [ -f '/home/daytona/.superplane/secrets.env.sh' ]")
	assert.Contains(t, command, "&& echo hello")
}
